<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script type="module">
import { HandLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let handLandmarker;
let lastX = null, lastY = null;

// USB micro:bit
let port, writer;

async function connectMicrobit() {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();
}
await connectMicrobit();

async function sendAction(action){
    if(!writer) return;
    await writer.write(new TextEncoder().encode(action + "\n"));
}

async function init(){
    const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
    );
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: { modelAssetPath: "./hand_landmarker.task" },
        runningMode: "VIDEO",
        numHands: 1,
    });
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    video.onloadedmetadata = ()=>{video.play(); requestAnimationFrame(loop);}
}

async function loop(timestamp){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const results = await handLandmarker.detectForVideo(video, timestamp);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    if(results.landmarks?.length){
        const drawingUtils=new DrawingUtils(ctx);
        for(const lm of results.landmarks){
            drawingUtils.drawConnectors(lm,HandLandmarker.HAND_CONNECTIONS);
            drawingUtils.drawLandmarks(lm);
        }

        const wrist = results.landmarks[0][0];
        if(lastX!==null){
            const dx = wrist.x - lastX;
            const dy = wrist.y - lastY;
            let action = "";
            if(Math.abs(dx)>Math.abs(dy)){
                action = dx>0?"RIGHT":"LEFT";
            }else{
                action = dy>0?"DOWN":"UP";
            }
            await sendAction(action);
        }
        lastX = wrist.x;
        lastY = wrist.y;
    }

    requestAnimationFrame(loop);
}

window.addEventListener("load", init);
</script>

<script type="module">
import {
  HandLandmarker,
  FilesetResolver,
  DrawingUtils
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

const statusEl = document.getElementById("status");
const actionEl = document.getElementById("action");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const connectBtn = document.getElementById("connectBtn");

// USB 串口
let port = null;
let writer = null;

// 方向阈值（用手指方向，数值越小越灵敏，太小会抖）
let dirThreshold = 0.08;   // 手指向量长度最小值
let framesNeeded = 3;      // 需要连续多少帧同一个方向
let cooldown = 150;        // 冷却时间(ms)

// 去抖动状态
let currentAction = null;
let actionCounter = 0;
let lastSent = 0;

// 把英文动作转中文
function toChinese(a) {
  return a === "LEFT"  ? "左" :
         a === "RIGHT" ? "右" :
         a === "UP"    ? "上" :
         a === "DOWN"  ? "下" :
         "等待动作...";
}

// 串口发送给 micro:bit
async function sendAction(a) {
  if (!writer) return;
  let msg = "0";
  if (a === "LEFT")  msg = "L";
  if (a === "RIGHT") msg = "R";
  if (a === "UP")    msg = "U";
  if (a === "DOWN")  msg = "D";
  await writer.write(new TextEncoder().encode(msg + "\n"));
}

// 连接 micro:bit (USB)
connectBtn.addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    writer = port.writable.getWriter();
    connectBtn.disabled = true;
    statusEl.textContent = "micro:bit 已连接（USB）";
  } catch (e) {
    statusEl.textContent = "连接失败：" + e;
    console.error(e);
  }
});

// MediaPipe 初始化
let handLandmarker;

async function init() {
  statusEl.textContent = "加载模型...";
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
  );

  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: { modelAssetPath: "./hand_landmarker.task" },
    runningMode: "VIDEO",
    numHands: 1,
  });

  statusEl.textContent = "模型加载完成，启动摄像头...";
  startCamera();
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        statusEl.textContent = "摄像头已启动";
        requestAnimationFrame(loop);
      };
    })
    .catch(err => {
      statusEl.textContent = "无法访问摄像头：" + err;
      console.error(err);
    });
}

async function loop(timestamp) {
  if (!handLandmarker) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const results = await handLandmarker.detectForVideo(video, timestamp);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  if (results.landmarks && results.landmarks.length > 0) {
    const lm = results.landmarks[0]; // 第一只手
    const drawingUtils = new DrawingUtils(ctx);
    drawingUtils.drawConnectors(lm, HandLandmarker.HAND_CONNECTIONS);
    drawingUtils.drawLandmarks(lm);

    // wrist: lm[0], index fingertip: lm[8]
    const wrist = lm[0];
    const tip   = lm[8];

    const vx = tip.x - wrist.x; // 水平向量，>0 右，<0 左
    const vy = tip.y - wrist.y; // 垂直向量，>0 下，<0 上

    let detected = null;

    // 向量长度足够才算是“明确指向”
    const len = Math.hypot(vx, vy);
    if (len > dirThreshold) {
      if (Math.abs(vx) > Math.abs(vy)) {
        // 左右比上下更明显
        detected = vx > 0 ? "RIGHT" : "LEFT";
      } else {
        // 上下比左右更明显（注意 y 越小越靠上）
        detected = vy > 0 ? "DOWN" : "UP";
      }
    }

    // 去抖：检测连续多帧同一方向
    if (detected && detected === currentAction) {
      actionCounter++;
    } else if (detected) {
      currentAction = detected;
      actionCounter = 1;
    } else {
      currentAction = null;
      actionCounter = 0;
    }

    const now = performance.now();

    if (
      currentAction &&
      actionCounter >= framesNeeded &&
      now - lastSent > cooldown
    ) {
      actionEl.textContent = toChinese(currentAction);
      await sendAction(currentAction);
      lastSent = now;
    } else if (!currentAction && now - lastSent > 300) {
      actionEl.textContent = "等待动作...";
    }

  } else {
    actionEl.textContent = "没有检测到手";
    currentAction = null;
    actionCounter = 0;
  }

  requestAnimationFrame(loop);
}

window.addEventListener("load", init);
</script>
